name: Build Obfuscate BPB Panel

on:
  push:
    branches:
      - main
  schedule:
    - cron: "0 1 * * *"
    workflow_dispatch:     # æ·»åŠ æ‰‹åŠ¨è§¦å‘é€‰é¡¹

permissions:
  contents: write

jobs:
  build:
    name: ğŸ› ï¸ Build and Obfuscate BPB Panel
    runs-on: ubuntu-latest
    steps:
      # ä»£ç æ£€å‡º
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # ç¼“å­˜è®¾ç½®
      - name: ğŸ’¾ Cache npm dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      # ç¯å¢ƒè®¾ç½®
      - name: âš™ï¸ Setup Node.js environment
        uses: actions/setup-node@v4
        with:
          node-version: "latest"
          cache: 'npm'

      # ä¾èµ–å®‰è£…
      - name: ğŸ“¦ Install dependencies
        run: |
          echo "Installing required packages..."
          for i in {1..3}; do 
            npm install -g javascript-obfuscator && break || sleep 5
          done
          
          echo "Installing system dependencies..."
          sudo apt-get update
          sudo apt-get install -y jq
          
          echo "Verification:"
          javascript-obfuscator --version
          jq --version

      # æ–‡ä»¶ä¸‹è½½
      - name: ğŸŒ Download latest worker.js
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Fetching latest release information..."
          RELEASE_INFO=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/bia-pain-bache/BPB-Worker-Panel/releases/latest")
          
          RELEASE_TAG=$(echo "$RELEASE_INFO" | jq -r '.tag_name')
          DOWNLOAD_URL=$(echo "$RELEASE_INFO" | jq -r '.assets[] | select(.name == "worker.js") | .browser_download_url')
          
          echo "ğŸ“¦ Latest Release: $RELEASE_TAG"
          echo "ğŸ”— Download URL: $DOWNLOAD_URL"
          
          if [ -z "$DOWNLOAD_URL" ]; then
            echo "âŒ Error: Could not find worker.js in latest release"
            exit 1
          fi
          
          echo "Downloading worker.js..."
          wget -q --show-progress -O origin.js "$DOWNLOAD_URL"
          
          echo "ğŸ“ File details:"
          ls -lh origin.js
          echo "ğŸ” First 10 lines:"
          head -n 10 origin.js

      # ä»£ç æ··æ·†
      - name: ğŸ”’ Obfuscate BPB worker
        run: |
          echo "Starting obfuscation process..."
          javascript-obfuscator origin.js \
            --output _worker.js \
            --compact true \
            --identifier-names-generator hexadecimal \
            --string-array true \
            --string-array-threshold 0.5 \
            --simplify true
          
          echo "ğŸ“Š Obfuscation completed:"
          echo "ğŸ“ Output file details:"
          ls -lh _worker.js
          echo "ğŸ” First 10 lines of obfuscated code:"
          head -n 10 _worker.js
          
          # æ–‡ä»¶å¤§å°æ£€æŸ¥
          FILE_SIZE=$(stat -f %z _worker.js 2>/dev/null || stat -c %s _worker.js)
          echo "ğŸ“ File size: $FILE_SIZE bytes"
          
          if [ "$FILE_SIZE" -gt 500000 ]; then
            echo "âš ï¸  Warning: _worker.js size exceeds 500KB, may cause Cloudflare CPU limit errors"
          else
            echo "âœ… File size within acceptable limits"
          fi

      # æäº¤æ›´æ”¹
      - name: ğŸ“ Commit changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          branch: main
          commit_message: |
            :arrow_up: chore: update latest BPB panel
            - Automated update from latest release
            - Obfuscated worker script
          commit_author: 'github-actions[bot] <github-actions[bot]@users.noreply.github.com>'
          commit_user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_options: '--signoff'
