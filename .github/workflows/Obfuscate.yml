name: ğŸ”§ Build Obfuscate BPB Panel

on:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 1 * * *'  # æ¯å¤©å‡Œæ™¨1ç‚¹è‡ªåŠ¨è¿è¡Œ
  workflow_dispatch:     # æ·»åŠ æ‰‹åŠ¨è§¦å‘é€‰é¡¹

env:
  NODE_VERSION: '20'    # å›ºå®š Node.js ç‰ˆæœ¬
  OUTPUT_FILE: '_worker.js'
  SOURCE_FILE: 'origin.js'

permissions:
  contents: write
  packages: read

jobs:
  build-and-obfuscate:
    name: ğŸ› ï¸ æ„å»ºå’Œæ··æ·† Worker
    runs-on: ubuntu-latest
    
    steps:
      # ç¬¬ä¸€æ­¥ï¼šå‡†å¤‡ç¯å¢ƒ
      - name: ğŸ“¥ æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ğŸ’¾ è®¾ç½® npm ç¼“å­˜
        uses: actions/cache@v4
        id: npm-cache
        with:
          path: |
            ~/.npm
            node_modules
          key: ${{ runner.os }}-node-${{ env.NODE_VERSION }}-npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-${{ env.NODE_VERSION }}-npm-

      - name: âš™ï¸ è®¾ç½® Node.js ç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      # ç¬¬äºŒæ­¥ï¼šå®‰è£…ä¾èµ–
      - name: ğŸ“¦ å®‰è£…ç³»ç»Ÿä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl wget

      - name: ğŸ”§ å®‰è£… JavaScript æ··æ·†å·¥å…·
        run: |
          max_retries=3
          for i in $(seq 1 $max_retries); do
            echo "å°è¯•å®‰è£… javascript-obfuscator (ç¬¬ $i æ¬¡)..."
            if npm install -g javascript-obfuscator; then
              echo "âœ… å®‰è£…æˆåŠŸ"
              break
            else
              echo "âŒ å®‰è£…å¤±è´¥ï¼Œ5ç§’åé‡è¯•..."
              sleep 5
            fi
          done
          javascript-obfuscator --version

      # ç¬¬ä¸‰æ­¥ï¼šè·å–æºæ–‡ä»¶
      - name: ğŸŒ è·å–æœ€æ–° Worker æ–‡ä»¶
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: 'bia-pain-bache/BPB-Worker-Panel'
        run: |
          echo "æ­£åœ¨ä»ä»“åº“ $REPO è·å–æœ€æ–°å‘å¸ƒç‰ˆæœ¬..."
          
          # è·å–å‘å¸ƒä¿¡æ¯
          RELEASE_INFO=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/$REPO/releases/latest")
          
          RELEASE_TAG=$(echo "$RELEASE_INFO" | jq -r '.tag_name')
          RELEASE_NAME=$(echo "$RELEASE_INFO" | jq -r '.name')
          
          echo "ğŸ¯ æœ€æ–°ç‰ˆæœ¬: $RELEASE_NAME ($RELEASE_TAG)"
          
          # æŸ¥æ‰¾ worker.js ä¸‹è½½é“¾æ¥
          DOWNLOAD_URL=$(echo "$RELEASE_INFO" | jq -r '.assets[] | select(.name == "worker.js") | .browser_download_url')
          
          if [ -z "$DOWNLOAD_URL" ] || [ "$DOWNLOAD_URL" = "null" ]; then
            echo "âŒ é”™è¯¯: åœ¨æœ€æ–°å‘å¸ƒä¸­æ‰¾ä¸åˆ° worker.js æ–‡ä»¶"
            echo "å¯ç”¨èµ„æºæ–‡ä»¶:"
            echo "$RELEASE_INFO" | jq -r '.assets[].name'
            exit 1
          fi
          
          echo "ğŸ“¥ ä¸‹è½½åœ°å€: $DOWNLOAD_URL"
          echo "ä¿å­˜ä¸º: $SOURCE_FILE"
          
          # ä¸‹è½½æ–‡ä»¶
          wget -q --show-progress -O "$SOURCE_FILE" "$DOWNLOAD_URL"
          
          # éªŒè¯æ–‡ä»¶
          if [ ! -s "$SOURCE_FILE" ]; then
            echo "âŒ é”™è¯¯: ä¸‹è½½çš„æ–‡ä»¶ä¸ºç©º"
            exit 1
          fi
          
          echo "âœ… æ–‡ä»¶ä¸‹è½½æˆåŠŸ"
          echo "ğŸ“Š æ–‡ä»¶ä¿¡æ¯:"
          ls -lh "$SOURCE_FILE"
          echo "ğŸ“„ æ–‡ä»¶å‰10è¡Œå†…å®¹:"
          head -n 10 "$SOURCE_FILE"

      # ç¬¬å››æ­¥ï¼šä»£ç æ··æ·†
      - name: ğŸ›¡ï¸ æ··æ·† Worker ä»£ç 
        run: |
          echo "å¼€å§‹ä»£ç æ··æ·†å¤„ç†..."
          
          javascript-obfuscator "$SOURCE_FILE" \
            --output "$OUTPUT_FILE" \
            --compact true \
            --control-flow-flattening true \
            --control-flow-flattening-threshold 0.75 \
            --numbers-to-expressions true \
            --simplify true \
            --shuffle-string-array true \
            --split-strings true \
            --split-strings-chunk-length 10 \
            --string-array true \
            --string-array-indexes-type hexadecimal \
            --string-array-encoding rc4 \
            --string-array-threshold 0.75 \
            --identifier-names-generator hexadecimal \
            --transform-object-keys true
          
          echo "âœ… æ··æ·†å®Œæˆ"
          echo "ğŸ“Š è¾“å‡ºæ–‡ä»¶ä¿¡æ¯:"
          ls -lh "$OUTPUT_FILE"
          
          # æ˜¾ç¤ºæ–‡ä»¶å‰10è¡Œ
          echo "ğŸ“„ æ··æ·†åæ–‡ä»¶å‰10è¡Œ:"
          head -n 10 "$OUTPUT_FILE"
          
          # æ–‡ä»¶å¤§å°æ£€æŸ¥
          FILE_SIZE=$(stat -c %s "$OUTPUT_FILE" 2>/dev/null || stat -f %z "$OUTPUT_FILE")
          echo "ğŸ“ æ–‡ä»¶å¤§å°: $FILE_SIZE å­—èŠ‚ ($((FILE_SIZE/1024)) KB)"
          
          if [ "$FILE_SIZE" -gt 500000 ]; then
            echo "âš ï¸  è­¦å‘Š: $OUTPUT_FILE æ–‡ä»¶å¤§å°è¶…è¿‡ 500KBï¼Œå¯èƒ½å¯¼è‡´ Cloudflare CPU é™åˆ¶é”™è¯¯"
          else
            echo "âœ… æ–‡ä»¶å¤§å°åœ¨å®‰å…¨èŒƒå›´å†…"
          fi

      # ç¬¬äº”æ­¥ï¼šæäº¤æ›´æ”¹
      - name: âœ… æäº¤æ··æ·†ç»“æœ
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          branch: main
          commit_message: |
            :arrow_up: æ›´æ–° BPB Panel æ··æ·†ç‰ˆæœ¬
            - è‡ªåŠ¨æ›´æ–°æœ€æ–° Worker æ–‡ä»¶
            - ä»£ç æ··æ·†å¤„ç†å®Œæˆ
            - æ–‡ä»¶å¤§å°: $((FILE_SIZE/1024)) KB
          commit_author: 'github-actions[bot] <github-actions[bot]@users.noreply.github.com>'
          commit_user_email: 'actions@github.com'
          file_pattern: '**/_worker.js'
          skip_fetch: true

      # ç¬¬å…­æ­¥ï¼šå®Œæˆé€šçŸ¥
      - name: ğŸ‰ æ„å»ºå®Œæˆ
        run: |
          echo "========================================"
          echo "âœ… BPB Panel æ··æ·†æ„å»ºå®Œæˆ!"
          echo "ğŸ“ è¾“å…¥æ–‡ä»¶: $SOURCE_FILE"
          echo "ğŸ“ è¾“å‡ºæ–‡ä»¶: $OUTPUT_FILE"
          echo "ğŸ“ æ–‡ä»¶å¤§å°: $((FILE_SIZE/1024)) KB"
          echo "ğŸ•’ å®Œæˆæ—¶é—´: $(date)"
          echo "========================================"
