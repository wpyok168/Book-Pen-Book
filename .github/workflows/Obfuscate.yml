name: ğŸ”§ Build Obfuscate BPB Panel

on:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 1 * * *'  # æ¯å¤©å‡Œæ™¨1ç‚¹è‡ªåŠ¨è¿è¡Œ
  workflow_dispatch:     # æ·»åŠ æ‰‹åŠ¨è§¦å‘é€‰é¡¹

env:
  NODE_VERSION: 'latest'    # å›ºå®š Node.js ç‰ˆæœ¬ '20'
  OUTPUT_FILE: '_worker.js'
  SOURCE_FILE: 'origin.js'

permissions:
  contents: write

jobs:
  build-and-obfuscate:
    name: ğŸ› ï¸ æ„å»ºå’Œæ··æ·† Worker
    runs-on: ubuntu-latest
    
    steps:
      # ç¬¬ä¸€æ­¥ï¼šå‡†å¤‡ç¯å¢ƒ
      - name: ğŸ“¥ æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: âš™ï¸ è®¾ç½® Node.js ç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      # ç¬¬äºŒæ­¥ï¼šå®‰è£…å¿…è¦å·¥å…·
      - name: ğŸ› ï¸ å®‰è£…ç³»ç»Ÿå·¥å…·
        run: |
          echo "å®‰è£…å¿…è¦çš„ç³»ç»Ÿå·¥å…·..."
          sudo apt-get update
          sudo apt-get install -y jq curl wget
          echo "âœ… ç³»ç»Ÿå·¥å…·å®‰è£…å®Œæˆ"

      - name: ğŸ”§ å®‰è£… JavaScript æ··æ·†å·¥å…·
        run: |
          echo "å¼€å§‹å®‰è£… javascript-obfuscator..."
          max_retries=3
          for i in $(seq 1 $max_retries); do
            echo "å°è¯•å®‰è£… (ç¬¬ $i/$max_retries æ¬¡)..."
            if npm install -g javascript-obfuscator; then
              echo "âœ… javascript-obfuscator å®‰è£…æˆåŠŸ"
              break
            else
              echo "âŒ å®‰è£…å¤±è´¥ï¼Œ5ç§’åé‡è¯•..."
              sleep 5
            fi
            if [ $i -eq $max_retries ]; then
              echo "âŒ æ‰€æœ‰é‡è¯•æ¬¡æ•°å·²ç”¨å®Œï¼Œå®‰è£…å¤±è´¥"
              exit 1
            fi
          done
          
          # éªŒè¯å®‰è£…å¹¶æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯
          echo "éªŒè¯å®‰è£…ç‰ˆæœ¬:"
          javascript-obfuscator --version

      # ç¬¬ä¸‰æ­¥ï¼šè·å–æºæ–‡ä»¶
      - name: ğŸŒ è·å–æœ€æ–° Worker æ–‡ä»¶
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: 'bia-pain-bache/BPB-Worker-Panel'
        run: |
          echo "ğŸ”„ æ­£åœ¨ä»ä»“åº“ $REPO è·å–æœ€æ–°å‘å¸ƒç‰ˆæœ¬..."
          
          # è·å–å‘å¸ƒä¿¡æ¯
          RELEASE_INFO=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/$REPO/releases/latest")
          
          if [ $? -ne 0 ]; then
            echo "âŒ è·å–å‘å¸ƒä¿¡æ¯å¤±è´¥"
            exit 1
          fi
          
          RELEASE_TAG=$(echo "$RELEASE_INFO" | jq -r '.tag_name')
          RELEASE_NAME=$(echo "$RELEASE_INFO" | jq -r '.name')
          
          echo "ğŸ¯ æœ€æ–°ç‰ˆæœ¬: $RELEASE_NAME ($RELEASE_TAG)"
          
          # æŸ¥æ‰¾ worker.js ä¸‹è½½é“¾æ¥
          DOWNLOAD_URL=$(echo "$RELEASE_INFO" | jq -r '.assets[] | select(.name == "worker.js") | .browser_download_url')
          
          if [ -z "$DOWNLOAD_URL" ] || [ "$DOWNLOAD_URL" = "null" ]; then
            echo "âŒ é”™è¯¯: åœ¨æœ€æ–°å‘å¸ƒä¸­æ‰¾ä¸åˆ° worker.js æ–‡ä»¶"
            echo "ğŸ“‹ å¯ç”¨çš„èµ„æºæ–‡ä»¶:"
            echo "$RELEASE_INFO" | jq -r '.assets[].name' || echo "æ— å¯ç”¨èµ„æº"
            exit 1
          fi
          
          echo "ğŸ“¥ ä¸‹è½½åœ°å€: $DOWNLOAD_URL"
          echo "ğŸ’¾ ä¿å­˜ä¸º: $SOURCE_FILE"
          
          # ä¸‹è½½æ–‡ä»¶
          echo "å¼€å§‹ä¸‹è½½æ–‡ä»¶..."
          wget -O "$SOURCE_FILE" "$DOWNLOAD_URL"
          
          # éªŒè¯æ–‡ä»¶
          if [ ! -f "$SOURCE_FILE" ]; then
            echo "âŒ é”™è¯¯: æ–‡ä»¶ä¸‹è½½å¤±è´¥"
            exit 1
          fi
          
          if [ ! -s "$SOURCE_FILE" ]; then
            echo "âŒ é”™è¯¯: ä¸‹è½½çš„æ–‡ä»¶ä¸ºç©º"
            exit 1
          fi
          
          echo "âœ… æ–‡ä»¶ä¸‹è½½æˆåŠŸ"
          echo "ğŸ“Š æ–‡ä»¶è¯¦ç»†ä¿¡æ¯:"
          ls -lh "$SOURCE_FILE"
          echo "ğŸ“„ æ–‡ä»¶é¢„è§ˆ (å‰5è¡Œ):"
          head -n 5 "$SOURCE_FILE"

      # ç¬¬å››æ­¥ï¼šä»£ç æ··æ·†ï¼ˆä½¿ç”¨æœ€åŸºæœ¬çš„å…¼å®¹é…ç½®ï¼‰
      - name: ğŸ›¡ï¸ æ··æ·† Worker ä»£ç 
        run: |
          echo "ğŸ›¡ï¸ å¼€å§‹ä»£ç æ··æ·†å¤„ç†..."
          
          if [ ! -f "$SOURCE_FILE" ]; then
            echo "âŒ é”™è¯¯: æºæ–‡ä»¶ $SOURCE_FILE ä¸å­˜åœ¨"
            exit 1
          fi
          
          echo "ğŸ“ æºæ–‡ä»¶å¤§å°: $(du -h "$SOURCE_FILE" | cut -f1)"
          echo "ğŸ”§ æ‰§è¡Œæ··æ·†..."
          
          # ä½¿ç”¨æœ€åŸºæœ¬ä¸”å…¼å®¹çš„æ··æ·†é…ç½®
          javascript-obfuscator "$SOURCE_FILE" \
            --output "$OUTPUT_FILE" \
            --compact true \
            --identifier-names-generator hexadecimal \
            --string-array true \
            --string-array-threshold 0.5 \
            --simplify true
          
          if [ $? -ne 0 ]; then
            echo "âŒ æ··æ·†å¤„ç†å¤±è´¥"
            exit 1
          fi
          
          if [ ! -f "$OUTPUT_FILE" ]; then
            echo "âŒ é”™è¯¯: è¾“å‡ºæ–‡ä»¶æœªç”Ÿæˆ"
            exit 1
          fi
          
          echo "âœ… æ··æ·†å®Œæˆ"
          echo "ğŸ“Š è¾“å‡ºæ–‡ä»¶ä¿¡æ¯:"
          ls -lh "$OUTPUT_FILE"
          
          # æ–‡ä»¶å¤§å°æ£€æŸ¥
          FILE_SIZE=$(stat -c %s "$OUTPUT_FILE" 2>/dev/null || stat -f %z "$OUTPUT_FILE")
          FILE_SIZE_KB=$((FILE_SIZE/1024))
          
          echo "ğŸ“ æ–‡ä»¶å¤§å°: $FILE_SIZE å­—èŠ‚ (${FILE_SIZE_KB} KB)"
          
          if [ "$FILE_SIZE" -gt 500000 ]; then
            echo "âš ï¸  è­¦å‘Š: è¾“å‡ºæ–‡ä»¶å¤§å°è¶…è¿‡ 500KBï¼Œå¯èƒ½å¯¼è‡´ Cloudflare CPU é™åˆ¶é”™è¯¯"
          else
            echo "âœ… æ–‡ä»¶å¤§å°åœ¨å®‰å…¨èŒƒå›´å†…"
          fi

      # ç¬¬äº”æ­¥ï¼šæ‰‹åŠ¨æ·»åŠ å¹¶æäº¤æ–‡ä»¶
      - name: ğŸ“ æ‰‹åŠ¨æ·»åŠ æ–‡ä»¶åˆ° Git
        run: |
          echo "å°†æ–‡ä»¶æ·»åŠ åˆ° Git æš‚å­˜åŒº..."
          git config --local user.email "actions@github.com"
          git config --local user.name "github-actions[bot]"
          
          # æ·»åŠ  origin.js å’Œ _worker.js åˆ° Git
          git add "$SOURCE_FILE" "$OUTPUT_FILE"
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å·²æ·»åŠ 
          echo "å·²æš‚å­˜çš„æ–‡ä»¶:"
          git status --porcelain
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          echo "æ–‡ä»¶å­˜åœ¨æ€§æ£€æŸ¥:"
          ls -la "$SOURCE_FILE" "$OUTPUT_FILE" 2>/dev/null || echo "æŸäº›æ–‡ä»¶ä¸å­˜åœ¨"

      # ç¬¬å…­æ­¥ï¼šæäº¤æ›´æ”¹
      - name: âœ… æäº¤æ··æ·†ç»“æœ
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          branch: main
          commit_message: |
            :arrow_up: chore: è‡ªåŠ¨æ›´æ–° BPB Panel ç‰ˆæœ¬
            
            - åŒæ­¥æœ€æ–° Worker æºæ–‡ä»¶: ${{ env.SOURCE_FILE }}
            - å®Œæˆä»£ç æ··æ·†å¤„ç†: ${{ env.OUTPUT_FILE }}
            - è¾“å‡ºæ–‡ä»¶å¤§å°: ${FILE_SIZE_KB} KB
            - ç‰ˆæœ¬: $RELEASE_TAG
          commit_author: 'github-actions[bot] <github-actions[bot]@users.noreply.github.com>'
          commit_user_email: 'actions@github.com'
          # ä¸æŒ‡å®š file_patternï¼Œè®© action è‡ªåŠ¨æ£€æµ‹æ‰€æœ‰æ›´æ”¹
          skip_fetch: true

      # ç¬¬ä¸ƒæ­¥ï¼šå®Œæˆé€šçŸ¥
      - name: ğŸ‰ æ„å»ºå®Œæˆæ€»ç»“
        run: |
          echo "========================================"
          echo "ğŸ‰ BPB Panel æ„å»ºå®Œæˆ!"
          echo "========================================"
          echo "ğŸ“ æºæ–‡ä»¶: $SOURCE_FILE"
          echo "ğŸ“ æ··æ·†æ–‡ä»¶: $OUTPUT_FILE" 
          echo "ğŸ“ æ··æ·†æ–‡ä»¶å¤§å°: $FILE_SIZE_KB KB"
          echo "ğŸ·ï¸ ç‰ˆæœ¬: $RELEASE_TAG"
          echo "ğŸ•’ å®Œæˆæ—¶é—´: $(date)"
          echo "âœ… æ‰€æœ‰æ­¥éª¤æ‰§è¡ŒæˆåŠŸ"
          echo "========================================"
