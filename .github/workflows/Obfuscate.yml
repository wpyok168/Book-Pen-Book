name: ğŸ”§ Build Obfuscate BPB Panel

on:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 1 * * *'  # æ¯å¤©å‡Œæ™¨1ç‚¹è‡ªåŠ¨è¿è¡Œ
  workflow_dispatch:     # æ·»åŠ æ‰‹åŠ¨è§¦å‘é€‰é¡¹

env:
  NODE_VERSION: '20'    # å›ºå®š Node.js ç‰ˆæœ¬
  OUTPUT_FILE: '_worker.js'
  SOURCE_FILE: 'origin.js'

permissions:
  contents: write

jobs:
  build-and-obfuscate:
    name: ğŸ› ï¸ æ„å»ºå’Œæ··æ·† Worker
    runs-on: ubuntu-latest
    
    steps:
      # ç¬¬ä¸€æ­¥ï¼šå‡†å¤‡ç¯å¢ƒ
      - name: ğŸ“¥ æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: âš™ï¸ è®¾ç½® Node.js ç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'  # ç§»é™¤ç¼“å­˜ä¾èµ–ï¼Œå› ä¸ºä¸éœ€è¦ package.json

      # ç¬¬äºŒæ­¥ï¼šå®‰è£…å¿…è¦å·¥å…·
      - name: ğŸ› ï¸ å®‰è£…ç³»ç»Ÿå·¥å…·
        run: |
          echo "å®‰è£…å¿…è¦çš„ç³»ç»Ÿå·¥å…·..."
          sudo apt-get update
          sudo apt-get install -y jq curl wget
          echo "âœ… ç³»ç»Ÿå·¥å…·å®‰è£…å®Œæˆ"

      - name: ğŸ”§ å®‰è£… JavaScript æ··æ·†å·¥å…·
        run: |
          echo "å¼€å§‹å®‰è£… javascript-obfuscator..."
          max_retries=3
          for i in $(seq 1 $max_retries); do
            echo "å°è¯•å®‰è£… (ç¬¬ $i/$max_retries æ¬¡)..."
            if npm install -g javascript-obfuscator; then
              echo "âœ… javascript-obfuscator å®‰è£…æˆåŠŸ"
              break
            else
              echo "âŒ å®‰è£…å¤±è´¥ï¼Œ5ç§’åé‡è¯•..."
              sleep 5
            fi
            if [ $i -eq $max_retries ]; then
              echo "âŒ æ‰€æœ‰é‡è¯•æ¬¡æ•°å·²ç”¨å®Œï¼Œå®‰è£…å¤±è´¥"
              exit 1
            fi
          done
          
          # éªŒè¯å®‰è£…
          echo "éªŒè¯å®‰è£…ç‰ˆæœ¬:"
          javascript-obfuscator --version

      # ç¬¬ä¸‰æ­¥ï¼šè·å–æºæ–‡ä»¶
      - name: ğŸŒ è·å–æœ€æ–° Worker æ–‡ä»¶
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: 'bia-pain-bache/BPB-Worker-Panel'
        run: |
          echo "ğŸ”„ æ­£åœ¨ä»ä»“åº“ $REPO è·å–æœ€æ–°å‘å¸ƒç‰ˆæœ¬..."
          
          # è·å–å‘å¸ƒä¿¡æ¯
          RELEASE_INFO=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/$REPO/releases/latest")
          
          if [ $? -ne 0 ]; then
            echo "âŒ è·å–å‘å¸ƒä¿¡æ¯å¤±è´¥"
            exit 1
          fi
          
          RELEASE_TAG=$(echo "$RELEASE_INFO" | jq -r '.tag_name')
          RELEASE_NAME=$(echo "$RELEASE_INFO" | jq -r '.name')
          
          echo "ğŸ¯ æœ€æ–°ç‰ˆæœ¬: $RELEASE_NAME ($RELEASE_TAG)"
          
          # æŸ¥æ‰¾ worker.js ä¸‹è½½é“¾æ¥
          DOWNLOAD_URL=$(echo "$RELEASE_INFO" | jq -r '.assets[] | select(.name == "worker.js") | .browser_download_url')
          
          if [ -z "$DOWNLOAD_URL" ] || [ "$DOWNLOAD_URL" = "null" ]; then
            echo "âŒ é”™è¯¯: åœ¨æœ€æ–°å‘å¸ƒä¸­æ‰¾ä¸åˆ° worker.js æ–‡ä»¶"
            echo "ğŸ“‹ å¯ç”¨çš„èµ„æºæ–‡ä»¶:"
            echo "$RELEASE_INFO" | jq -r '.assets[].name' || echo "æ— å¯ç”¨èµ„æº"
            exit 1
          fi
          
          echo "ğŸ“¥ ä¸‹è½½åœ°å€: $DOWNLOAD_URL"
          echo "ğŸ’¾ ä¿å­˜ä¸º: $SOURCE_FILE"
          
          # ä¸‹è½½æ–‡ä»¶
          echo "å¼€å§‹ä¸‹è½½æ–‡ä»¶..."
          wget --progress=bar:force -O "$SOURCE_FILE" "$DOWNLOAD_URL" 2>&1 | tail -n 10
          
          # éªŒè¯æ–‡ä»¶
          if [ ! -f "$SOURCE_FILE" ]; then
            echo "âŒ é”™è¯¯: æ–‡ä»¶ä¸‹è½½å¤±è´¥"
            exit 1
          fi
          
          if [ ! -s "$SOURCE_FILE" ]; then
            echo "âŒ é”™è¯¯: ä¸‹è½½çš„æ–‡ä»¶ä¸ºç©º"
            exit 1
          fi
          
          echo "âœ… æ–‡ä»¶ä¸‹è½½æˆåŠŸ"
          echo "ğŸ“Š æ–‡ä»¶è¯¦ç»†ä¿¡æ¯:"
          ls -lh "$SOURCE_FILE"
          echo "ğŸ“„ æ–‡ä»¶é¢„è§ˆ (å‰5è¡Œ):"
          head -n 5 "$SOURCE_FILE"

      # ç¬¬å››æ­¥ï¼šä»£ç æ··æ·†
      - name: ğŸ›¡ï¸ æ··æ·† Worker ä»£ç 
        run: |
          echo "ğŸ›¡ï¸ å¼€å§‹ä»£ç æ··æ·†å¤„ç†..."
          
          if [ ! -f "$SOURCE_FILE" ]; then
            echo "âŒ é”™è¯¯: æºæ–‡ä»¶ $SOURCE_FILE ä¸å­˜åœ¨"
            exit 1
          fi
          
          echo "ğŸ“ æºæ–‡ä»¶å¤§å°: $(du -h "$SOURCE_FILE" | cut -f1)"
          echo "ğŸ”§ æ‰§è¡Œæ··æ·†..."
          
          javascript-obfuscator "$SOURCE_FILE" \
            --output "$OUTPUT_FILE" \
            --compact true \
            --control-flow-flattening false \
            --dead-code-injection false \
            --debug-protection false \
            --debug-protection-interval false \
            --disable-console-output false \
            --identifier-names-generator hexadecimal \
            --log false \
            --numbers-to-expressions true \
            --rename-globals false \
            --rotate-string-array true \
            --self-defending false \
            --shuffle-string-array true \
            --simplify true \
            --split-strings true \
            --split-strings-chunk-length 10 \
            --string-array true \
            --string-array-encoding false \
            --string-array-index-shift true \
            --string-array-indexes-type hexadecimal \
            --string-array-threshold 0.75 \
            --string-array-wrappers-count 1 \
            --string-array-wrappers-chained-calls true \
            --string-array-wrappers-parameters-max-count 2 \
            --string-array-wrappers-type variable \
            --transform-object-keys true \
            --unicode-escape-sequence false
          
          if [ $? -ne 0 ]; then
            echo "âŒ æ··æ·†å¤„ç†å¤±è´¥"
            exit 1
          fi
          
          echo "âœ… æ··æ·†å®Œæˆ"
          echo "ğŸ“Š è¾“å‡ºæ–‡ä»¶ä¿¡æ¯:"
          ls -lh "$OUTPUT_FILE"
          
          # æ–‡ä»¶å¤§å°æ£€æŸ¥
          FILE_SIZE=$(stat -c %s "$OUTPUT_FILE" 2>/dev/null || stat -f %z "$OUTPUT_FILE")
          FILE_SIZE_KB=$((FILE_SIZE/1024))
          
          echo "ğŸ“ æ–‡ä»¶å¤§å°: $FILE_SIZE å­—èŠ‚ (${FILE_SIZE_KB} KB)"
          
          if [ "$FILE_SIZE" -gt 500000 ]; then
            echo "âš ï¸  è­¦å‘Š: è¾“å‡ºæ–‡ä»¶å¤§å°è¶…è¿‡ 500KBï¼Œå¯èƒ½å¯¼è‡´ Cloudflare CPU é™åˆ¶é”™è¯¯"
          else
            echo "âœ… æ–‡ä»¶å¤§å°åœ¨å®‰å…¨èŒƒå›´å†…"
          fi
          
          echo "ğŸ“„ æ··æ·†åæ–‡ä»¶é¢„è§ˆ (å‰3è¡Œ):"
          head -n 3 "$OUTPUT_FILE"

      # ç¬¬äº”æ­¥ï¼šæäº¤æ›´æ”¹
      - name: âœ… æäº¤æ··æ·†ç»“æœ
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          branch: main
          commit_message: |
            :arrow_up: chore: è‡ªåŠ¨æ›´æ–° BPB Panel æ··æ·†ç‰ˆæœ¬
            
            - è‡ªåŠ¨åŒæ­¥æœ€æ–° Worker æ–‡ä»¶
            - å®Œæˆä»£ç æ··æ·†å¤„ç†
            - è¾“å‡ºæ–‡ä»¶å¤§å°: ${FILE_SIZE_KB} KB
            - æ„å»ºæ—¶é—´: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          commit_author: 'github-actions[bot] <github-actions[bot]@users.noreply.github.com>'
          commit_user_email: 'actions@github.com'
          file_pattern: |
            _worker.js
            origin.js
          skip_fetch: false
          status_options: '--untracked-files=no'

      # ç¬¬å…­æ­¥ï¼šå®Œæˆé€šçŸ¥
      - name: ğŸ‰ æ„å»ºå®Œæˆæ€»ç»“
        run: |
          echo "========================================"
          echo "ğŸ‰ BPB Panel æ··æ·†æ„å»ºå®Œæˆ!"
          echo "========================================"
          echo "ğŸ“ è¾“å…¥æ–‡ä»¶: $SOURCE_FILE"
          echo "ğŸ“ è¾“å‡ºæ–‡ä»¶: $OUTPUT_FILE" 
          echo "ğŸ“ æ–‡ä»¶å¤§å°: $FILE_SIZE_KB KB"
          echo "ğŸ•’ å®Œæˆæ—¶é—´: $(date)"
          echo "âœ… æ‰€æœ‰æ­¥éª¤æ‰§è¡ŒæˆåŠŸ"
          echo "========================================"
